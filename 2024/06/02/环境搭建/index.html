<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/%E6%A0%91%E5%8F%B6_sleaves.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/%E6%A0%91%E5%8F%B6_sleaves.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.1/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="经过调研，我们对现有的云边通信框架有了充分的认识与了解，但是尚停留在理论阶段，没有进行过实际测试。因此，我们在小组成员个人笔记本中分别搭建了Kubeedge、Openyurt以及SuperEdge的测试环境，部署了一个主节点和三个边缘节点用以进行测试。以下是实验搭建步骤。">
<meta property="og:type" content="article">
<meta property="og:title" content="实验环境搭建">
<meta property="og:url" content="http://example.com/2024/06/02/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/index.html">
<meta property="og:site_name" content="Muziyu&#39;s Blog">
<meta property="og:description" content="经过调研，我们对现有的云边通信框架有了充分的认识与了解，但是尚停留在理论阶段，没有进行过实际测试。因此，我们在小组成员个人笔记本中分别搭建了Kubeedge、Openyurt以及SuperEdge的测试环境，部署了一个主节点和三个边缘节点用以进行测试。以下是实验搭建步骤。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-06-02T11:32:12.000Z">
<meta property="article:modified_time" content="2024-06-02T14:17:36.587Z">
<meta property="article:author" content="aliang">
<meta property="article:tag" content="-环境搭建">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2024/06/02/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>实验环境搭建 | Muziyu's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/rss2.xml" title="Muziyu's Blog" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Muziyu's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-file fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-code">

    <a href="/code/" rel="section"><i class="fa fa-code fa-fw"></i>代码</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-notes fa-fw"></i>notes</a>

  </li>
        <li class="menu-item menu-item-留言板">

    <a href="/guestbook/" rel="section"><i class="newpaper-o fa-fw"></i>留言板</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/02/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/maimai.jpg">
      <meta itemprop="name" content="aliang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Muziyu's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          实验环境搭建
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-02 19:32:12 / 修改时间：22:17:36" itemprop="dateCreated datePublished" datetime="2024-06-02T19:32:12+08:00">2024-06-02</time>
            </span>

          
            <div class="post-description">经过调研，我们对现有的云边通信框架有了充分的认识与了解，但是尚停留在理论阶段，没有进行过实际测试。因此，我们在小组成员个人笔记本中分别搭建了Kubeedge、Openyurt以及SuperEdge的测试环境，部署了一个主节点和三个边缘节点用以进行测试。以下是实验搭建步骤。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="KubeMDES实验环境搭建"><a href="#KubeMDES实验环境搭建" class="headerlink" title="KubeMDES实验环境搭建"></a>KubeMDES实验环境搭建</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>使用virtualbox在两台物理计算机上搭建测试环境，虚拟机使用双网卡，桥接有线网卡连接主机，使用nat网卡上网</p>
<p>虚拟机硬件配置</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>硬盘</th>
<th>内存</th>
<th>CPU</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>100G</td>
<td>4G</td>
<td>Intel Core i7-12700F 4核 4.9GHz</td>
</tr>
<tr>
<td>node1</td>
<td>100G</td>
<td>2G</td>
<td>Intel Core i7-12700F 2核 4.9GHz</td>
</tr>
<tr>
<td>node2</td>
<td>100G</td>
<td>2G</td>
<td>Intel Core i7-12700F 2核 4.9GHz</td>
</tr>
<tr>
<td>node3</td>
<td>100G</td>
<td>2G</td>
<td>Intel Core i7-12700F 2核 4.9GHz</td>
</tr>
<tr>
<td>node100-124</td>
<td>100G</td>
<td>1G</td>
<td>Intel Core i5-10600KF @ 2x 4.8GHz</td>
</tr>
</tbody></table>
<p>软件配置，由于兼容性问题，使用kubernetes1.22，KubeEdge1.12.2</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>操作系统</th>
</tr>
</thead>
<tbody><tr>
<td>external-master</td>
<td>192.168.0.10</td>
<td>Ubuntu20.04</td>
</tr>
<tr>
<td>external-node</td>
<td>192.168.0.11</td>
<td>Ubuntu20.04</td>
</tr>
<tr>
<td>kubeedge-master</td>
<td>192.168.0.20</td>
<td>Ubuntu20.04</td>
</tr>
<tr>
<td>kubeedge-node1</td>
<td>192.168.0.21</td>
<td>Ubuntu20.04</td>
</tr>
<tr>
<td>kubeedge-node2</td>
<td>192.168.0.22</td>
<td>Ubuntu20.04</td>
</tr>
<tr>
<td>kubeedge-node3</td>
<td>192.168.0.23</td>
<td>Ubuntu20.04</td>
</tr>
</tbody></table>
<h2 id="初始化系统配置"><a href="#初始化系统配置" class="headerlink" title="初始化系统配置"></a>初始化系统配置</h2><p>所有主机修改主机名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo hostnamectl set-hostname master</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>所有主机关闭防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop ufw</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> ufw</span><br></pre></td></tr></table></figure>

<p>所有主机禁用swap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/fstab</span><br><span class="line"><span class="comment"># 注释swap那一行</span></span><br><span class="line">sudo swapon -a <span class="comment"># 启用所有swap</span></span><br><span class="line">sudo swapoff -a <span class="comment"># 禁用所有swap</span></span><br><span class="line">sudo swapon -s <span class="comment"># 查看swap状态</span></span><br></pre></td></tr></table></figure>

<p>所有主机设置时间同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y ntpdate</span><br><span class="line">sudo ntpdate time.windows.com</span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>所有节点添加hosts</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加hosts</span></span><br><span class="line">sudo vi /etc/hosts</span><br><span class="line"><span class="comment"># 加入如下几行</span></span><br><span class="line">185.199.108.133 raw.githubusercontent.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启用ipv4转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 注释下面行</span></span><br><span class="line">/etc/sysctl.conf: net.ipv4.ip_forward = 1</span><br><span class="line">sudo sysctl -p /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>所有节点安装抓包库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install libpcap-dev</span><br></pre></td></tr></table></figure>

<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>我们选择安装docker.io ubuntu的版本，省事</p>
<p><strong>记住，需要在所有节点上都安装docker</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure>

<p>docker官方镜像仓库访问比较慢，可以使用dockerhub国内源加速</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://knjsrl1b.mirror.aliyuncs.com&quot;</span>,<span class="string">&quot;https://docker.hub.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 阿里云镜像加速 https://knjsrl1b.mirror.aliyuncs.com</span></span><br><span class="line"><span class="comment"># 中科大镜像加速 https://docker.mirrors.ustc.edu.cn</span></span><br><span class="line"><span class="comment"># 节点加入&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="安装Kubernetes"><a href="#安装Kubernetes" class="headerlink" title="安装Kubernetes"></a>安装Kubernetes</h2><p>考虑到兼容性，我们选择kubernetes1.22.17进行安装</p>
<p>根据阿里云的<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes">教程</a>，在<strong>2台云主机上</strong>，使用阿里源安装kubelet，kubeadm和kubectl组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">sudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">sudo vi /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="comment"># 输入以下内容：</span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">sudo apt update</span><br><span class="line"><span class="comment"># 可先使用apt list kubelet -a 查看所有版本，再指定版本</span></span><br><span class="line">apt install -y kubelet=1.22.17-00 kubeadm=1.22.17-00 kubectl=1.22.17-00</span><br></pre></td></tr></table></figure>

<p>在云master主机上使用kubeadm创建kubernetes集群，这里我们使用阿里云的镜像进行加速，这里kubeadm会安装和自己版本匹配的kubernetes</p>
<p>如果主机的IP就是公网IP，那么初始化如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.0.10 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>如果云的服务器的公网IP在主机上看不到，因此这里选择让apiserver监听所有网卡的地址，并且添加额外的公网IP作为认证许可的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=0.0.0.0 \</span><br><span class="line">  --apiserver-cert-extra-sans=139.9.72.62 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>执行完毕会输出很多提示指令需要我们执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.0.10:6443 --token 4j3yrg.40sy24ptjd6gufda \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:4d5c1a14381289e5cbe62ee1d72f612133cd5ec823ad4a5a36009074d56fa3dd </span><br></pre></td></tr></table></figure>

<p>我们按照提示在普通用户和root用户下都执行一次，这样kubectl就可以访问到本地的kube-api-server了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>我们接着安装CNI网络插件，下载太慢了可以使用这个<a target="_blank" rel="noopener" href="https://ipaddress.com/website/raw.githubusercontent.com">网站</a>查询raw.githubusercontent.com的IP地址并且写入hosts文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>执行 <code>kubectl get pods -n kube-flannel</code>如果出现如下说明网络插件安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kube-flannel-ds-hgn9l            1/1     Running   0          44m</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>让master也作为工作节点可以运行用户Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>

<p>让master不参与运行用户Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node master node-role.kubernetes.io/master=:NoSchedule</span><br></pre></td></tr></table></figure>

<p>过一会，在master主机上执行 <code>kubectl get nodes</code>，如下则加入成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class="line">master   Ready    control-plane,master   13m   v1.22.15</span><br></pre></td></tr></table></figure>

<p>在 Kubernetes 集群中创建一个 pod，验证是否正常运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get pod,svc</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-6799fc88d8-hf2m9   1/1     Running   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        14m</span><br><span class="line">service/nginx        NodePort    10.104.74.138   &lt;none&gt;        80:31332/TCP   8s</span><br></pre></td></tr></table></figure>

<p>可以看到nginx暴露的端口号为31332，因此我们访问地址：<a href="http://39.106.4.225:31332可以成功访问nginx首页">http://39.106.4.225:31332可以成功访问nginx首页</a></p>
<h2 id="安装KubeEdge"><a href="#安装KubeEdge" class="headerlink" title="安装KubeEdge"></a>安装KubeEdge</h2><p>考虑到兼容性，我们选择kubernetes1.22.17进行安装</p>
<p>根据阿里云的<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes">教程</a>，在<strong>1台master上</strong>，使用阿里源安装kubelet，kubeadm和kubectl组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">sudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">sudo vi /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="comment"># 输入以下内容：</span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">sudo apt update</span><br><span class="line"><span class="comment"># 可先使用apt list kubelet -a 查看所有版本，再指定版本</span></span><br><span class="line">apt install -y kubelet=1.22.17-00 kubeadm=1.22.17-00 kubectl=1.22.17-00</span><br></pre></td></tr></table></figure>

<p>在云master主机上使用kubeadm创建kubernetes集群，这里我们使用阿里云的镜像进行加速，这里kubeadm会安装和自己版本匹配的kubernetes</p>
<p>如果主机的IP就是公网IP，那么初始化如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.0.20 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>如果云的服务器的公网IP在主机上看不到，因此这里选择让apiserver监听所有网卡的地址，并且添加额外的公网IP作为认证许可的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=0.0.0.0 \</span><br><span class="line">  --apiserver-cert-extra-sans=139.9.72.62 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>执行完毕会输出很多提示指令需要我们执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.0.20:6443 --token t72311.0xu95cw9drnyr0ay \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:3ba3826bf2ec686a38530e877a1919bbbb30ff1566712c9e17eb867ff8f0b7c9 </span><br></pre></td></tr></table></figure>

<p>我们按照提示在普通用户和root用户下都执行一次，这样kubectl就可以访问到本地的kube-api-server了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p>我们接着安装CNI网络插件，下载太慢了可以使用这个<a target="_blank" rel="noopener" href="https://ipaddress.com/website/raw.githubusercontent.com">网站</a>查询raw.githubusercontent.com的IP地址并且写入hosts文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>执行 <code>kubectl get pods -n kube-flannel</code>如果出现如下说明网络插件安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">kube-flannel-ds-hgn9l            1/1     Running   0          44m</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>让master也作为工作节点可以运行用户Pod（为了运行cloudcore，必须允许master运行用户Pod）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>

<p>让master不参与运行用户Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node master node-role.kubernetes.io/master=:NoSchedule</span><br></pre></td></tr></table></figure>

<p>过一会，在master主机上执行 <code>kubectl get nodes</code>，如下则加入成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class="line">master   Ready    control-plane,master   13m   v1.22.15</span><br></pre></td></tr></table></figure>

<p>在 Kubernetes 集群中创建一个 pod，验证是否正常运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get pod,svc</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-6799fc88d8-hf2m9   1/1     Running   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        14m</span><br><span class="line">service/nginx        NodePort    10.104.74.138   &lt;none&gt;        80:31332/TCP   8s</span><br></pre></td></tr></table></figure>

<p>可以看到nginx暴露的端口号为31332，因此我们访问地址：<a href="http://39.106.4.225:31332可以成功访问nginx首页">http://39.106.4.225:31332可以成功访问nginx首页</a></p>
<p>在kubeedge-cluster安装好了Kubernetes master节点以后，需要继续安装KubeEdge</p>
<p>kubeEdge和kubernetes类似，提供了keadm工具用来快速搭建kubeedge集群，我们可以提前在KubeEdge的github官网上面下载keadm1.12.2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubeedge/kubeedge/releases/download/v1.12.2/keadm-v1.12.2-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>在每个节点上</strong>安装keadm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf keadm-v1.12.2-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mv</span> keadm-v1.12.2-linux-amd64/keadm/keadm /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="云端安装"><a href="#云端安装" class="headerlink" title="云端安装"></a>云端安装</h3><p>使用keadm安装kubeedge的云端组件cloudcore</p>
<p>如果速度慢可以提前拉取cloudcore镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kubeedge/cloudcore:v1.12.2</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">keadm init --advertise-address=192.168.0.20 --profile version=v1.12.2</span><br><span class="line"><span class="comment"># 这些参数已经没有用了 --set cloudcore-tag=v1.13.0 --kubeedge-version=1.13.0</span></span><br><span class="line">Kubernetes version verification passed, KubeEdge installation will start...</span><br><span class="line">CLOUDCORE started</span><br><span class="line">=========CHART DETAILS=======</span><br><span class="line">NAME: cloudcore</span><br><span class="line">LAST DEPLOYED: Thu Nov  3 11:05:24 2022</span><br><span class="line">NAMESPACE: kubeedge</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br></pre></td></tr></table></figure>

<p>–advertise-address&#x3D;xxx.xx.xx.xx 这里的xxx.xx.xx.xx换成云主机的公网地址，–profile version&#x3D;v1.12.1 意思是指定安装的kubeEdge的版本，如果默认不指定那么keadm会自动去下载最新的版本</p>
<p>注意，这个命令会从仓库下载cloudcore容器镜像</p>
<p>我们可以看到cloudcore的Pod和service已经在运行了，cloudcore会监听本地的10000-10004端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod,svc -n kubeedge</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/cloudcore-5768d46f8d-fqdcn   1/1     Running   0          78s</span><br><span class="line"></span><br><span class="line">NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                                             AGE</span><br><span class="line">service/cloudcore   ClusterIP   10.99.61.17   &lt;none&gt;        10000/TCP,10001/TCP,10002/TCP,10003/TCP,10004/TCP   78s</span><br></pre></td></tr></table></figure>

<p>获得边缘设备接入的token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keadm gettoken</span><br><span class="line">17cd6d469308d3e6ffd7eaab1a8a9bfabb85e048d42452b665f1a21905f09709.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTEyMDQ2NjR9.pvsQ1otVhpt6urC0_HPNJFg6IHXM2sVZYZ9YT4QON_o</span><br></pre></td></tr></table></figure>

<h3 id="边缘节点安装"><a href="#边缘节点安装" class="headerlink" title="边缘节点安装"></a>边缘节点安装</h3><p>可以提前拉取镜像（提前拉取没有用）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull kubeedge/installation-package:v1.12.2</span><br></pre></td></tr></table></figure>

<p>加入集群，keadm会安装edgecore和mqtt协议的实现软件mosquitto，mosquitto会监听localhost:1183端口</p>
<p>1.12版本，如果报错，就加上–runtimetype&#x3D;docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keadm <span class="built_in">join</span> --cloudcore-ipport=192.168.0.20:10000 --kubeedge-version=1.12.2 --runtimetype=docker --token=17cd6d469308d3e6ffd7eaab1a8a9bfabb85e048d42452b665f1a21905f09709.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTEyMDQ2NjR9.pvsQ1otVhpt6urC0_HPNJFg6IHXM2sVZYZ9YT4QON_o</span><br></pre></td></tr></table></figure>

<p>由于1.13版本默认容器运行时为containerd，可手动指定runtimetype为docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo keadm <span class="built_in">join</span> --cloudcore-ipport=10.0.1.200:10000 --kubeedge-version=1.13.0 --runtimetype=docker --token=e708c06bed80e4330fd473021156f569e0957162a3dd5c138b3b09cd268841e1.eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2Nzg3OTcwMzJ9.x78zMhdvl6j_Ti-SXxGl2H8Zvoo523D385psWtcat18</span><br></pre></td></tr></table></figure>

<p><code>--cloudcore-ipport</code>是边缘节点能访问的云master主机的IP端口号，<code>--token</code>是上面云matster生成的识别码</p>
<p>安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">W1024 13:10:08.370505    4423 validation.go:71] NodeIP is empty , use default ip <span class="built_in">which</span> can connect to cloud.</span><br><span class="line">I1024 13:10:08.371425    4423 join.go:100] 9. Run EdgeCore daemon</span><br><span class="line">I1024 13:10:08.822777    4423 join.go:317] </span><br><span class="line">I1024 13:10:08.822789    4423 join.go:318] KubeEdge edgecore is running, For logs visit: journalctl -u edgecore.service -xe</span><br></pre></td></tr></table></figure>

<p>如果通过 <code>sudo systemctl status edgecore</code>发现服务失败，使用 <code>journalctl -u edgecore.service -xe</code>查看日志</p>
<p>在master上查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@master:~<span class="comment"># kubectl get node</span></span><br><span class="line">NAME        STATUS   ROLES                  AGE    VERSION</span><br><span class="line">edgenode1   Ready    agent,edge             10m    v1.22.6-kubeedge-v1.12.0</span><br><span class="line">edgenode2   Ready    agent,edge             5m8s   v1.22.6-kubeedge-v1.12.0</span><br><span class="line">edgenode3   Ready    agent,edge             2s     v1.22.6-kubeedge-v1.12.0</span><br><span class="line">master      Ready    control-plane,master   47m    v1.22.15 </span><br></pre></td></tr></table></figure>

<h2 id="配置kubectl-logs支持边缘节点"><a href="#配置kubectl-logs支持边缘节点" class="headerlink" title="配置kubectl logs支持边缘节点"></a>配置kubectl logs支持边缘节点</h2><p>边缘部署一个Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment nginx --image=nginx -oyaml --dry-run=client &gt; nginx.yaml</span><br><span class="line">vi nginx.yaml</span><br><span class="line"><span class="comment"># 在spec-spec中加入边缘亲和性</span></span><br><span class="line">	  affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">            - matchExpressions:</span><br><span class="line">              - key: node-role.kubernetes.io/edge</span><br><span class="line">                operator: In</span><br><span class="line">                values: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">kubectl apply -f nginx.yaml</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>可以看到nginx暴露的端口号为30865，因此我们在任意边缘节点访问地址：<code>curl http://node2:30865</code>可以成功访问nginx首页</p>
<p>这样默认搭建好的kubeedge不支持在master查看边缘节点logs，会有如下的报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs nginx-597c67fd4d-kx44m</span><br><span class="line">Error from server: Get <span class="string">&quot;https://192.168.40.10:10350/containerLogs/default/nginx-597c67fd4d-kx44m/nginx&quot;</span>: dial tcp 192.168.40.10:10350: i/o <span class="built_in">timeout</span></span><br></pre></td></tr></table></figure>

<p>参考官方文档教程<a target="_blank" rel="noopener" href="https://kubeedge.io/zh/docs/setup/keadm_zh/">使用Keadm进行部署 | KubeEdge一个支持边缘计算的开放平台</a></p>
<p>kube-proxy默认和kubeedge不兼容，因此我们考虑在边缘端移除kube-proxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit daemonsets.apps -n kube-system kube-proxy</span><br></pre></td></tr></table></figure>

<p>我们修改kube-proxy的节点亲和性，使其不存在于边缘节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a &#x27;#&#x27; will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">deprecated.daemonset.template.generation:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-06-20T12:43:20Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-proxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;92283&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">39dd85f5-8d7f-47ff-83b4-59df66de7803</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kube-proxy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> <span class="comment"># 在这里加入亲和性</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/edge</span></span><br><span class="line">                  <span class="attr">operator:</span> <span class="string">DoesNotExist</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/usr/local/bin/kube-proxy</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--config=/var/lib/kube-proxy/config.conf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--hostname-override=$(NODE_NAME)</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="string">......</span></span><br></pre></td></tr></table></figure>

<p>此时我们在云master上看系统的pod组件，发现边缘的kube-proxy已经消失了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -owide</span><br></pre></td></tr></table></figure>

<p>因为flannel不支持边缘环境，无法在边缘运行，等下使用edgemesh见<a target="_blank" rel="noopener" href="https://github.com/kubeedge/kubeedge/issues/2287">issue2287</a>，同样修改flannel的亲和性，使其不在边缘运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新部署flannel</span></span><br><span class="line">kubectl delete daemonset.apps/kube-flannel-ds -nkube-flannel</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">vi kube-flannel.yml</span><br><span class="line"><span class="comment"># kubectl edit -n kube-flannel daemonset.apps/kube-flannel-ds</span></span><br><span class="line">......<span class="comment"># 修改下面的affi亲和性</span></span><br><span class="line">- key: node-role.kubernetes.io/edge</span><br><span class="line">                  operator: DoesNotExist</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 重新部署</span></span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line"><span class="comment"># 再看，只有云主机上有运行了</span></span><br><span class="line">kubectl get all -nkube-flannel -owide </span><br></pre></td></tr></table></figure>

<p>查看Kubernetes 的 <code>ca.crt</code> 和 <code>ca.key</code> 文件都存在</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /etc/kubernetes/pki</span><br><span class="line">apiserver.crt              apiserver.key                 ca.crt  front-proxy-ca.crt      front-proxy-client.key</span><br><span class="line">apiserver-etcd-client.crt  apiserver-kubelet-client.crt  ca.key  front-proxy-ca.key      sa.key</span><br><span class="line">apiserver-etcd-client.key  apiserver-kubelet-client.key  etcd    front-proxy-client.crt  sa.pub</span><br></pre></td></tr></table></figure>

<p>在云端节点为CloudStream生成证书，其中 <code>certgen.sh</code>在kubeedge源码中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubeedge/kubeedge/archive/refs/tags/v1.13.0.tar.gz</span><br><span class="line">tar -xf v1.13.0.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> /etc/kubeedge</span><br><span class="line"><span class="built_in">cp</span> kubeedge-1.13.0/build/tools/certgen.sh /etc/kubeedge/</span><br><span class="line"><span class="built_in">cd</span> /etc/kubeedge/</span><br><span class="line">sudo su</span><br><span class="line"><span class="built_in">export</span> CLOUDCOREIPS=<span class="string">&quot;192.168.0.20&quot;</span></span><br><span class="line">bash /etc/kubeedge/certgen.sh stream</span><br></pre></td></tr></table></figure>

<p>在master设置iptables规则，把所有发往边缘edgecore10350的包全部转发给cloudcore，让edgecore通过stream来转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 端口10003和10350是 CloudStream 和 Edgecore 的默认端口</span></span><br><span class="line">iptables -t nat -A OUTPUT -p tcp --dport 10350 -j DNAT --to 192.168.0.20:10003</span><br></pre></td></tr></table></figure>

<p>修改边缘端edgecore配置文件 <code>/etc/kubeedge/config/edgecore.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/kubeedge/config/edgecore.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">edgeStream:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 修改为true</span></span><br><span class="line">    <span class="attr">handshakeTimeout:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">readDeadline:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">101.201</span><span class="number">.181</span><span class="number">.239</span><span class="string">:10004</span> <span class="comment"># 这个为cloudcore的ip地址</span></span><br><span class="line">    <span class="attr">tlsTunnelCAFile:</span> <span class="string">/etc/kubeedge/ca/rootCA.crt</span></span><br><span class="line">    <span class="attr">tlsTunnelCertFile:</span> <span class="string">/etc/kubeedge/certs/server.crt</span></span><br><span class="line">    <span class="attr">tlsTunnelPrivateKeyFile:</span> <span class="string">/etc/kubeedge/certs/server.key</span></span><br><span class="line">    <span class="attr">writeDeadline:</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>

<p>重启edgecore</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart edgecore</span><br></pre></td></tr></table></figure>

<p>然后边缘的edgecore就可以正常启动了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start edgecore</span><br><span class="line">sudo systemctl status edgecore</span><br><span class="line">● edgecore.service</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/edgecore.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Thu 2022-07-07 16:53:51 CST; 4s ago</span><br><span class="line">   Main PID: 58760 (edgecore)</span><br><span class="line">      Tasks: 10 (<span class="built_in">limit</span>: 992)</span><br><span class="line">     Memory: 36.5M</span><br><span class="line">        CPU: 315ms</span><br><span class="line">     CGroup: /system.slice/edgecore.service</span><br><span class="line">             └─58760 /usr/local/bin/edgecore</span><br></pre></td></tr></table></figure>

<p>现在就可以正常在云端看边缘的logs了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs nginx-597c67fd4d-hwmdz</span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>同样地，这个云边通信隧道可以让我们访问边缘节点10350端口的metrics</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动apiserver本地代理</span></span><br><span class="line">kubectl proxy --address=<span class="string">&#x27;0.0.0.0&#x27;</span> --accept-hosts=<span class="string">&#x27;^*$&#x27;</span> --port=18080</span><br><span class="line"><span class="comment"># 利用kubeedge代理，从apiserver 访问边缘节点的metrics</span></span><br><span class="line">curl -i localhost:18080/api/v1/nodes/node101/proxy/metrics</span><br></pre></td></tr></table></figure>

<h2 id="安装EdgeMesh"><a href="#安装EdgeMesh" class="headerlink" title="安装EdgeMesh"></a>安装EdgeMesh</h2><p>在边缘不使用kube-proxy以后，边缘需要一个网络代理插件，这里我们使用kubeedge官方的edgemesh</p>
<p>EdgeMesh 相当于kube-proxy+flannel+coreDNS</p>
<p>edgemesh现在从kubeedge独立出来了，有自己专门的文档网站<a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/zh/">介绍 | EdgeMesh</a>，根据文档edgemesh是一个不依赖kubeedge的独立的k8s网络代理，只需要在master节点上使用helm安装就可以了</p>
<p>去除 K8s master 节点的污点，如果 K8s master 节点上没有部署需要被代理的应用，此步骤也可以不执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>

<p>正常情况下你不会希望 EdgeMesh 去代理 Kubernetes API 服务，因此需要给它添加过滤标签，更多信息请参考 <a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/advanced/hybird-proxy.html#%E6%9C%8D%E5%8A%A1%E8%BF%87%E6%BB%A4">服务过滤</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label services kubernetes service.edgemesh.kubeedge.io/service-proxy-name=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>启用 KubeEdge 的边缘 Kube-API 端点服务</p>
<p>在云端，开启 dynamicController 模块，配置完成后，需要重启 cloudcore</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit cm cloudcore -n kubeedge</span><br><span class="line">modules:</span><br><span class="line">  ...</span><br><span class="line">  dynamicController:</span><br><span class="line">    <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 杀死cloudcore容器</span></span><br><span class="line">kubectl get all -nkubeedge</span><br><span class="line">kubectl delete -nkubeedge pod/cloudcore-6687684d4d-92cvz</span><br></pre></td></tr></table></figure>

<p>在边缘节点，打开 metaServer 模块，配置完成后，需要重启 edgecore</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/kubeedge/config/edgecore.yaml</span><br><span class="line">modules:</span><br><span class="line">  ...</span><br><span class="line">  metaManager:</span><br><span class="line">    metaServer:</span><br><span class="line">      <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 重启 edgecore</span></span><br><span class="line">sudo systemctl restart edgecore</span><br></pre></td></tr></table></figure>

<p>在边缘节点，配置 clusterDNS 和 clusterDomain，配置完成后，需要重启 edgecore（这是为了边缘应用能够访问到 EdgeMesh 的 DNS 服务，与边缘 Kube-API 端点本身无关，但为了配置的流畅性，还是放在这里说明。</p>
<p>clusterDNS 设置的值 ‘169.254.96.16’ 来自于 <a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/zh/reference/config-items.html#edgemesh-agent-cfg">commonConfig</a> 中 bridgeDeviceIP 的默认值，正常情况下无需修改，非得修改请保持两者一致。）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/kubeedge/config/edgecore.yaml</span><br><span class="line">modules:</span><br><span class="line">  ...</span><br><span class="line">  edged:</span><br><span class="line">    ...</span><br><span class="line">    tailoredKubeletConfig:</span><br><span class="line">      ...</span><br><span class="line">      clusterDNS:</span><br><span class="line">      - 169.254.96.16</span><br><span class="line">      clusterDomain: cluster.local</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 重启 edgecore</span></span><br><span class="line">sudo systemctl restart edgecore</span><br></pre></td></tr></table></figure>

<p>最后，在边缘节点，测试边缘 Kube-API 端点功能是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1:10550/api/v1/services</span><br><span class="line"><span class="comment"># 出现apiversion开头的json字符串说明正常</span></span><br><span class="line">&#123;<span class="string">&quot;apiVersion&quot;</span>:<span class="string">&quot;v1&quot;</span>,<span class="string">&quot;items&quot;</span>:[&#123;<span class="string">&quot;api......</span></span><br></pre></td></tr></table></figure>

<p>主机安装helm3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.11.0-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v3.11.0-linux-amd64.tar.gz</span><br><span class="line">sudo <span class="built_in">mv</span> linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<p>设置helm repo仓库，这里使用微软仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>

<p>生成PSK密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -<span class="built_in">base64</span> 32</span><br><span class="line">JDhvPrqj/mA/2zA4P9voxqQIR8ectRzY8pDKaD+vlHo=</span><br></pre></td></tr></table></figure>

<p>helm安装edgemesh，只有一个master节点作为中继节点，暴露地址写云主机公网IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm install edgemesh --namespace kubeedge \</span><br><span class="line">--<span class="built_in">set</span> agent.psk=JDhvPrqj/mA/2zA4P9voxqQIR8ectRzY8pDKaD+vlHo= \</span><br><span class="line">--<span class="built_in">set</span> agent.relayNodes[0].nodeName=master,agent.relayNodes[0].advertiseAddress=<span class="string">&quot;&#123;192.168.0.20&#125;&quot;</span> \</span><br><span class="line">https://raw.githubusercontent.com/kubeedge/edgemesh/main/build/helm/edgemesh.tgz</span><br><span class="line"><span class="comment"># 使用v1.13.1旧版的edgemesh，去如下链接下载旧版的edgemesh.tgz</span></span><br><span class="line">https://github.com/kubeedge/edgemesh/blob/d9319537620fded8ce6281573b0bedfd334e72ea/build/helm/edgemesh.tgz</span><br></pre></td></tr></table></figure>

<p>多个中继节点，如果一个边缘局域网内要做到服务可访问，应该在局域网内设置一个rely节点(似乎不用)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm install edgemesh --namespace kubeedge \</span><br><span class="line">--<span class="built_in">set</span> agent.psk=udj41ZTdaQNb0gUaS64QuLgkFNTYy9dlXKg6bvQYuls= \</span><br><span class="line">--<span class="built_in">set</span> agent.relayNodes[0].nodeName=master,agent.relayNodes[0].advertiseAddress=<span class="string">&quot;&#123;101.201.181.239&#125;&quot;</span> \</span><br><span class="line">--<span class="built_in">set</span> agent.relayNodes[1].nodeName=edgenode2,agent.relayNodes[1].advertiseAddress=<span class="string">&quot;&#123;192.168.56.11&#125;&quot;</span> \</span><br><span class="line">--<span class="built_in">set</span> agent.relayNodes[2].nodeName=edgenode3,agent.relayNodes[2].advertiseAddress=<span class="string">&quot;&#123;192.168.56.12&#125;&quot;</span> \</span><br><span class="line">https://raw.githubusercontent.com/kubeedge/edgemesh/main/build/helm/edgemesh.tgz</span><br></pre></td></tr></table></figure>

<p>卸载edgemesh方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall edgemesh -n kubeedge</span><br></pre></td></tr></table></figure>

<p>检验部署结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm <span class="built_in">ls</span> -A</span><br><span class="line">NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART              APP VERSION  </span><br><span class="line">edgemesh        kubeedge        1               2022-10-08 22:36:18.261721438 +0800 CST deployed        edgemesh-0.1.0     latest</span><br></pre></td></tr></table></figure>

<p>再次检验</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl get all -n kubeedge -o wide</span><br><span class="line">NAME                             READY   STATUS              RESTARTS      AGE    IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/cloudcore-5768d46f8d-t8dnn   1/1     Running             1 (50m ago)   159m   172.28.40.134   master        &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/edgemesh-agent-4f5xt         0/1     ContainerCreating   0             4m8s   192.168.40.10   area1-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/edgemesh-agent-6czts         0/1     CrashLoopBackOff    5 (27s ago)   4m8s   172.28.40.134   master        &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/edgemesh-agent-krvsc         0/1     Pending             0             4m8s   &lt;none&gt;          area2-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/edgemesh-agent-p22b5         0/1     Pending             0             4m8s   &lt;none&gt;          area2-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/edgemesh-agent-tzq7g         0/1     Pending             0             4m8s   &lt;none&gt;          area1-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>云主机上的edgemesh启动崩溃，边缘上的edgemesh一直在下载镜像，创建容器和pending，可以看看是不是edgemesh镜像不是最新的造成的</p>
<p>等了一晚上，终于edgemesh镜像拉取完毕，在边缘运行起来了。</p>
<p>因为helm部署的edgemesh在重启后不会恢复，因此我们手动部署edgemesh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/kubeedge/edgemesh.git</span><br><span class="line"><span class="built_in">cd</span> edgemesh</span><br><span class="line">kubectl apply -f build/crds/istio/</span><br><span class="line"><span class="comment"># 设置 build/agent/resources/04-configmap.yaml 的 relayNodes，并重新生成 PSK 密码</span></span><br><span class="line">kubectl apply -f build/agent/resources/</span><br><span class="line"><span class="comment"># 检验部署结果</span></span><br><span class="line">kubectl get all -n kubeedge -o wide</span><br></pre></td></tr></table></figure>

<h2 id="KubeEdge编译"><a href="#KubeEdge编译" class="headerlink" title="KubeEdge编译"></a>KubeEdge编译</h2><p>集成测试</p>
<p>必须使用root用户下载和编译，否则git报错</p>
<p>首先安装必要的包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install git build-essential docker.io jq</span><br></pre></td></tr></table></figure>

<p>docker记得改国内源</p>
<p>克隆最新仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/kubeedge/kubeedge.git</span><br><span class="line"><span class="built_in">cd</span> kubeedge</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译cloudcore</span></span><br><span class="line">make all WHAT=cloudcore</span><br></pre></td></tr></table></figure>

<p>构建容器镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make image WHAT=cloudcore</span><br></pre></td></tr></table></figure>

<p>将 <code>kubeedge/hack/lib/golang.sh</code>229行中间的空格删除，最后编译成功</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goldflags=<span class="string">&quot;$&#123;GOLDFLAGS=-s -w -buildid=&#125;$(kubeedge::version::ldflags)&quot;</span></span><br></pre></td></tr></table></figure>

<p>verify可以在build文件夹下生成dockerfile打包文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make verify</span><br></pre></td></tr></table></figure>

<p>test对生成的二进制文件进行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>安装ginkgo测试框架</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/onsi/ginkgo/v2/ginkgo</span><br><span class="line">go get github.com/onsi/gomega/...</span><br></pre></td></tr></table></figure>

<p>集成测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make integrationtest</span><br></pre></td></tr></table></figure>

<p>edgecore直接编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go build -o _output/local/bin/edgecore -ldflags <span class="string">&#x27;-w -s&#x27;</span> github.com/kubeedge/kubeedge/edge/cmd/edgecore</span><br><span class="line"></span><br><span class="line">go build -o _output/local/bin/edgecore -ldflags <span class="string">&#x27;-s -w -buildid= -X github.com/kubeedge/kubeedge/pkg/version.gitCommit=b43a11b886b4e1e7993f9a8dfb0e7d6f1b7b11a2 -X github.com/kubeedge/kubeedge/pkg/version.gitTreeState=dirty -X github.com/kubeedge/kubeedge/pkg/version.gitVersion=v1.13.0-beta.0.25+b43a11b886b4e1-dirty -X github.com/kubeedge/kubeedge/pkg/version.gitMajor=1 -X github.com/kubeedge/kubeedge/pkg/version.gitMinor=13+&#x27;</span> github.com/kubeedge/kubeedge/edge/cmd/edgecore</span><br></pre></td></tr></table></figure>

<h2 id="Edgemesh编译"><a href="#Edgemesh编译" class="headerlink" title="Edgemesh编译"></a>Edgemesh编译</h2><p>编译edgemesh-agent</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make all WHAT=edgemesh-agent</span><br></pre></td></tr></table></figure>

<p>构建edgemesh-agent容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make agentimage</span><br></pre></td></tr></table></figure>

<p>将容器标签修改为kubeedge&#x2F;edgemesh-agent:v1.13.1-beta</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag af39a4309d5f kubeedge/edgemesh-agent:v1.13.1-beta</span><br></pre></td></tr></table></figure>

<p>得到edgemesh容器ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps|grep \&quot;edgemesh-agent\&quot; |awk <span class="string">&#x27;&#123;split($1, arr, &quot;\t&quot;); print arr[1]&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>复制文件到容器中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> _output/local/bin/edgemesh-agent 70fbdd29b9b7:/usr/local/bin/</span><br></pre></td></tr></table></figure>

<p>打包容器为镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit 70fbdd29b9b7 kubeedge/edgemesh-agent:v1.13.2</span><br></pre></td></tr></table></figure>

<h2 id="部署metrics-server"><a href="#部署metrics-server" class="headerlink" title="部署metrics-server"></a>部署metrics-server</h2><p>metaserver暴露在10550端口</p>
<p>edgecore的metrics指标暴露在127.0.0.1:10350</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -anp | grep edgecore</span><br><span class="line">curl localhost:10350/metrics</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在k8s的master节点上执行</span></span><br><span class="line"><span class="comment">#创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> metrics-server </span><br><span class="line"><span class="comment"># 下载metrics-server yaml文件</span></span><br><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.0/components.yaml -O deploy.yaml</span><br><span class="line"><span class="comment"># 修改配置如下,可以参考官方的配置</span></span><br><span class="line">vim deploy.yaml </span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">            - matchExpressions:</span><br><span class="line">              - key: node-role.kubernetes.io/master</span><br><span class="line">                operator: Exists</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io/master</span><br><span class="line">        operator: Exists</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 将容器镜像换成阿里云的仓库</span></span><br><span class="line">registry.aliyuncs.com/google_containers/metrics-server:v0.6.0</span><br></pre></td></tr></table></figure>

<h2 id="安装kubemark"><a href="#安装kubemark" class="headerlink" title="安装kubemark"></a>安装kubemark</h2><p>需要两个集群</p>
<ul>
<li>kubemark master: 被用来测试性能的Kubernetes集群，可以只有一个master节点，其他都是hollow node</li>
<li>external cluster: 被用来运行多个hollow node 的一般的Kubernetes集群</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/releases%E4%B8%8B%E8%BD%BDk8s1.22.17%E6%BA%90%E7%A0%81%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91kubemark">https://github.com/kubernetes/kubernetes/releases下载k8s1.22.17源码手动编译kubemark</a></p>
<p>查看编译教程</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/452f681d92d98d6d62dfb24fbc9c8da10935632c/contributors/devel/sig-scalability/kubemark-setup-guide.md">https://github.com/kubernetes/community/blob/452f681d92d98d6d62dfb24fbc9c8da10935632c/contributors/devel/sig-scalability/kubemark-setup-guide.md</a></p>
<p>链接打不开可以去<a target="_blank" rel="noopener" href="https://github.com/kubernetes/community%E6%90%9C%E7%B4%A2kubemark">https://github.com/kubernetes/community搜索kubemark</a></p>
<p>直接拉取镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull ss104301/kubemark</span><br></pre></td></tr></table></figure>

<p>创建namespace, configmap 和 secret</p>
<p>配置文件路径是hollow节点中kubelet和kube-proxy要使用的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns kubemark</span><br><span class="line">kubectl create configmap node-configmap -n kubemark --from-literal=content.type=<span class="string">&quot;test-cluster&quot;</span></span><br><span class="line">kubectl create secret generic kubeconfig --<span class="built_in">type</span>=Opaque --namespace=kubemark --from-file=kubelet.kubeconfig=/etc/kubernetes/kubelet.kubeconfig --from-file=kubeproxy.kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>或者将kubemark master节点的config文件(&#x2F;root&#x2F;.kube&#x2F;config)拷贝到当前路径，并传入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubemark master执行</span></span><br><span class="line">scp .kube/config root@192.168.0.10:~</span><br><span class="line"><span class="comment"># external master执行</span></span><br><span class="line">kubectl create secret generic kubeconfig --<span class="built_in">type</span>=Opaque --namespace=kubemark --from-file=kubelet.kubeconfig=config --from-file=kubeproxy.kubeconfig=config</span><br></pre></td></tr></table></figure>

<p>用yaml文件创建hollow节点，可以参考官方模板<a href="https://link.zhihu.com/?target=https://github.com/kubernetes/community/blob/452f681d92d98d6d62dfb24fbc9c8da10935632c/contributors/devel/sig-scalability/hollow-node_simplified_template.yaml">hollow-node_simplified_template.yaml</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi hollow-node_simplified_template.yaml</span><br></pre></td></tr></table></figure>

<p>写入以下内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hollow-node</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubemark</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">hollow-node</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">hollow-node</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-inotify-limit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/busybox:latest</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;sysctl&#x27;</span>, <span class="string">&#x27;-w&#x27;</span>, <span class="string">&#x27;fs.inotify.max_user_instances=200&#x27;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubeconfig-volume</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">kubeconfig</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-volume</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hollow-kubelet</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ss104301/kubemark:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4194</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10250</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10255</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTENT_TYPE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">node-configmap</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">content.type</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/kubemark</span> <span class="string">--morph=kubelet</span> <span class="string">--name=$(NODE_NAME)</span> <span class="string">--kubeconfig=/kubeconfig/kubelet.kubeconfig</span> <span class="string">$(CONTENT_TYPE)</span> <span class="string">--alsologtostderr</span> <span class="string">--v=2</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubeconfig-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/kubeconfig</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">50M</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hollow-proxy</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ss104301/kubemark:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONTENT_TYPE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">node-configmap</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">content.type</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/kubemark</span> <span class="string">--morph=proxy</span> <span class="string">--name=$(NODE_NAME)</span> <span class="string">--use-real-proxier=false</span> <span class="string">--kubeconfig=/kubeconfig/kubeproxy.kubeconfig</span> <span class="string">$(CONTENT_TYPE)</span> <span class="string">--alsologtostderr</span> <span class="string">--v=2</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubeconfig-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/kubeconfig</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logs-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">20m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">50M</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>参数  replicas:  表示的是kubemark集群中hollow节点的数量</li>
<li>参数  和 使用ss104301&#x2F;kubemark容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hollow-node_simplified_template.yaml</span><br></pre></td></tr></table></figure>

<h2 id="使用edgemark"><a href="#使用edgemark" class="headerlink" title="使用edgemark"></a>使用edgemark</h2><p>编译edgemark</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make all WHAT=edgemark</span><br><span class="line"><span class="comment"># 如果报错，可使用直接编译</span></span><br><span class="line">go build -o _output/local/bin/edgemark -gcflags= -ldflags <span class="string">&#x27;-s -w&#x27;</span> github.com/kubeedge/kubeedge/edge/cmd/edgemark</span><br><span class="line"><span class="comment"># 打包容器镜像</span></span><br><span class="line">make image WHAT=edgemark</span><br></pre></td></tr></table></figure>

<h2 id="本地搭建集群"><a href="#本地搭建集群" class="headerlink" title="本地搭建集群"></a>本地搭建集群</h2><p>将本地主机作为nat路由器上网</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将本地主机作为nat路由器上网</span></span><br><span class="line">sudo vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 注释下面行</span></span><br><span class="line">/etc/sysctl.conf: net.ipv4.ip_forward = 1</span><br><span class="line">sudo sysctl -p /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 设置nat转发</span></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o wlo1 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h2 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h2><p>我们使用prometheus从edgecore的10350端口采集metrics指标，使用grafana展示出来</p>
<p>执行以下命令创建一个名为 monitoring 的新命名空间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace monitoring</span><br></pre></td></tr></table></figure>

<p>Prometheus 使用 Kubernetes API 从 Nodes、Pods、Deployments 等等中读取所有可用的指标。因此，我们需要创建一个包含 read access 所需 API 组的 RBAC 策略，并将该策略绑定到monitoring 命名空间。</p>
<p>创建一个名为 <code>clusterRole.yaml</code>的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi clusterRole.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br></pre></td></tr></table></figure>

<p>创建角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f clusterRole.yaml</span><br></pre></td></tr></table></figure>

<p>创建 Config Map 保存 Prometheus 配置</p>
<p>在 Prometheus 的术语中，从端点集合收集指标的配置称为 <code>job</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi prometheus-config-map.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server-conf</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-server-conf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.rules:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - name: devopscube demo alert</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: High Pod Memory</span></span><br><span class="line"><span class="string">        expr: sum(container_memory_usage_bytes) &gt; 1</span></span><br><span class="line"><span class="string">        for: 1m</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: slack</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: High Memory Usage</span></span><br><span class="line"><span class="string"></span>  <span class="attr">prometheus.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 5s</span></span><br><span class="line"><span class="string">      evaluation_interval: 5s</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">      - /etc/prometheus/prometheus.rules</span></span><br><span class="line"><span class="string">    alerting:</span></span><br><span class="line"><span class="string">      alertmanagers:</span></span><br><span class="line"><span class="string">      - scheme: http</span></span><br><span class="line"><span class="string">        static_configs:</span></span><br><span class="line"><span class="string">        - targets:</span></span><br><span class="line"><span class="string">          - &quot;alertmanager.monitoring.svc:9093&quot;</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">      - job_name: &#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line"><span class="string">        kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: endpoints</span></span><br><span class="line"><span class="string">        scheme: https</span></span><br><span class="line"><span class="string">        tls_config:</span></span><br><span class="line"><span class="string">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">        relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">          action: keep</span></span><br><span class="line"><span class="string">          regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">      - job_name: &#x27;kubernetes-nodes&#x27;</span></span><br><span class="line"><span class="string">        scheme: https</span></span><br><span class="line"><span class="string">        tls_config:</span></span><br><span class="line"><span class="string">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">        bearer_token_file: /v￼ar/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">        kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: node</span></span><br><span class="line"><span class="string">        relabel_configs:</span></span><br><span class="line"><span class="string">        - action: labelmap</span></span><br><span class="line"><span class="string">          regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">          regex: (.+)</span></span><br><span class="line"><span class="string">          target_label: __metrics_path__</span></span><br><span class="line"><span class="string">          replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"><span class="string">      - job_name: &#x27;kubernetes-pods&#x27;</span></span><br><span class="line"><span class="string">        kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: pod</span></span><br><span class="line"><span class="string">        relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">          action: keep</span></span><br><span class="line"><span class="string">          regex: true</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: __metrics_path__</span></span><br><span class="line"><span class="string">          regex: (.+)</span></span><br><span class="line"><span class="string">        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">          replacement: $1:$2</span></span><br><span class="line"><span class="string">          target_label: __address__</span></span><br><span class="line"><span class="string">        - action: labelmap</span></span><br><span class="line"><span class="string">          regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_pod_name]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: kubernetes_pod_name</span></span><br><span class="line"><span class="string">      - job_name: &#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line"><span class="string">        scheme: https</span></span><br><span class="line"><span class="string">        tls_config:</span></span><br><span class="line"><span class="string">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">        kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: node</span></span><br><span class="line"><span class="string">        relabel_configs:</span></span><br><span class="line"><span class="string">        - action: labelmap</span></span><br><span class="line"><span class="string">          regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">        - target_label: __address__</span></span><br><span class="line"><span class="string">          replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">          regex: (.+)</span></span><br><span class="line"><span class="string">          target_label: __metrics_path__</span></span><br><span class="line"><span class="string">          replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"><span class="string">      - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line"><span class="string">        kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">        - role: endpoints</span></span><br><span class="line"><span class="string">        relabel_configs:</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">          action: keep</span></span><br><span class="line"><span class="string">          regex: true</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: __scheme__</span></span><br><span class="line"><span class="string">          regex: (https?)</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: __metrics_path__</span></span><br><span class="line"><span class="string">          regex: (.+)</span></span><br><span class="line"><span class="string">        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: __address__</span></span><br><span class="line"><span class="string">          regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">          replacement: $1:$2</span></span><br><span class="line"><span class="string">        - action: labelmap</span></span><br><span class="line"><span class="string">          regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">        - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class="line"><span class="string">          action: replace</span></span><br><span class="line"><span class="string">          target_label: kubernetes_name</span></span><br></pre></td></tr></table></figure>

<p>promethues抓取metrics原理，参考</p>
<p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/pshizhsysu/prometheus/1868379">https://www.kancloud.cn/pshizhsysu/prometheus/1868379</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43883625/article/details/129760390">https://blog.csdn.net/weixin_43883625/article/details/129760390</a></p>
<p>创建configmap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f prometheus-config-map.yaml</span><br></pre></td></tr></table></figure>

<p>创建 Prometheus 部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi prometheus-deployment.yaml</span><br></pre></td></tr></table></figure>

<p>加入节点选择器，使得prometheus 的Pod运行在master节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention.time=12h&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus/&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">500M</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/prometheus/</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-server-conf</span></span><br><span class="line">  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f prometheus-deployment.yaml </span><br></pre></td></tr></table></figure>

<p>检查创建的部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deployments --namespace=monitoring</span><br><span class="line">kubectl get pod -A</span><br></pre></td></tr></table></figure>

<p>将 Prometheus 公开为服务 NodePort</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi prometheus-service.yaml</span><br></pre></td></tr></table></figure>

<p>我们将在 port <code>30000</code> 上的所有 kubernetes 节点 IP 上公开 Prometheus</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span>   <span class="string">&#x27;9090&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9090</span> </span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30000</span></span><br></pre></td></tr></table></figure>

<p>创建服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f prometheus-service.yaml</span><br></pre></td></tr></table></figure>

<p>浏览器访问prometheus网页，选择status-&gt;target，所有target都成功抓取到</p>
<h2 id="部署grafana"><a href="#部署grafana" class="headerlink" title="部署grafana"></a>部署grafana</h2><p>创建configmap文件并部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi grafana-datasource-config.yaml</span><br><span class="line">kubectl apply -f grafana-datasource-config.yaml</span><br></pre></td></tr></table></figure>

<p>grafana-datasource-config.yaml文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yaml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;apiVersion&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;datasources&quot;: [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">               &quot;access&quot;:&quot;proxy&quot;,</span></span><br><span class="line"><span class="string">                &quot;editable&quot;: true,</span></span><br><span class="line"><span class="string">                &quot;name&quot;: &quot;prometheus&quot;,</span></span><br><span class="line"><span class="string">                &quot;orgId&quot;: 1,</span></span><br><span class="line"><span class="string">                &quot;type&quot;: &quot;prometheus&quot;,</span></span><br><span class="line"><span class="string">                &quot;url&quot;: &quot;http://prometheus-service.monitoring.svc:8080&quot;,</span></span><br><span class="line"><span class="string">                &quot;version&quot;: 1</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure>

<p>创建grafana-deployment.yaml文件并部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi grafana-deployment.yaml</span><br><span class="line">kubectl apply -f grafana-deployment.yaml</span><br></pre></td></tr></table></figure>

<p>我们没有使用持久化存储，理论上这是不安全的，重启后监控数据会丢失</p>
<p>记得设置节点选择器，使grafana容器运行在master节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">node-role.kubernetes.io/master:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/grafana:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">          <span class="attr">requests:</span> </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">500M</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana-storage</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/grafana/provisioning/datasources</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">            <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-storage</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">              <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grafana-datasources</span></span><br></pre></td></tr></table></figure>

<p>创建并部署服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi grafana-service.yaml</span><br><span class="line">kubectl apply -f grafana-service.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">prometheus.io/port:</span>   <span class="string">&#x27;3000&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">32000</span></span><br></pre></td></tr></table></figure>

<p>登录grafana：<a target="_blank" rel="noopener" href="http://masterip:32000/">http://masterIP:32000</a></p>
<p>默认用户名和密码是admin</p>
<p>在grafana中创建新dashboard，添加三个panel曲线图，查询语句分别如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sum(rate(node_kubeedge_cloud_edge_metadata_traffic_collector<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">[</span><span class="number">30</span>s<span class="punctuation">]</span>)) by (instance)</span><br><span class="line">sum(rate(node_kubeedge_edge_edge_packet_collector<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">[</span><span class="number">30</span>s<span class="punctuation">]</span>)) by (instance)</span><br><span class="line">sum(rate(node_kubeedge_cloud_edge_packet_collector<span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">[</span><span class="number">30</span>s<span class="punctuation">]</span>)) by (instance)</span><br></pre></td></tr></table></figure>

<h2 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h2><p>一个应用，共400个Pod，在40个节点上以deamonset方式运行，每个节点包含10个Pod，400个Service，一个service包含80个endpoint，在test-app文件夹中</p>
<p>部署命令</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署</span></span><br><span class="line"><span class="string">./deploy-app.sh</span></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line"><span class="string">./delete-app.sh</span></span><br></pre></td></tr></table></figure>

<h2 id="测试kubeedge"><a href="#测试kubeedge" class="headerlink" title="测试kubeedge"></a>测试kubeedge</h2><p>11:30:00部署</p>
<p>11:36:40 pod启动完成</p>
<p>11:40:00删除</p>
<p>11:45:40删除完成</p>
<p>保存grafana数据</p>
<p>12:40:40部署</p>
<p>12:48:35 pod启动完成</p>
<p>11:50:30删除</p>
<p>11:55:30删除完成</p>
<p>保存grafana数据</p>
<p>20230808</p>
<p>21.25.00部署</p>
<p>21.27.45pod启动完毕</p>
<p>21.29.00删除</p>
<p>21.31.30删除完成</p>
<h2 id="测试mykubeedge"><a href="#测试mykubeedge" class="headerlink" title="测试mykubeedge"></a>测试mykubeedge</h2><p>12:14:10 部署</p>
<p>12:20:20 pod启动完成</p>
<p>12:23:00 删除</p>
<p>12:26:00 删除完成</p>
<p>保存grafana数据</p>
<p>20230808 leader&#x3D;101</p>
<p>21.51.30部署</p>
<p>21.53.40pod启动完毕</p>
<p>21.55.30删除</p>
<p>21.57.40删除完成</p>

    </div>

    
    
    

     

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag"><i class="fa fa-tag"></i>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/06/02/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E8%BD%AF%E4%BB%B6/" rel="prev" title="云原生容器管理软件">
      <i class="fa fa-chevron-left"></i> 云原生容器管理软件
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/06/02/Client-Go%E7%AC%94%E8%AE%B0/" rel="next" title="Client-Go笔记">
      Client-Go笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81ODI4OC8zNDc1MQ=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#KubeMDES%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.</span> <span class="nav-text">KubeMDES实验环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.</span> <span class="nav-text">初始化系统配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Docker"><span class="nav-number">1.3.</span> <span class="nav-text">安装Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Kubernetes"><span class="nav-number">1.4.</span> <span class="nav-text">安装Kubernetes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85KubeEdge"><span class="nav-number">1.5.</span> <span class="nav-text">安装KubeEdge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%91%E7%AB%AF%E5%AE%89%E8%A3%85"><span class="nav-number">1.5.1.</span> <span class="nav-text">云端安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%B9%E7%BC%98%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85"><span class="nav-number">1.5.2.</span> <span class="nav-text">边缘节点安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEkubectl-logs%E6%94%AF%E6%8C%81%E8%BE%B9%E7%BC%98%E8%8A%82%E7%82%B9"><span class="nav-number">1.6.</span> <span class="nav-text">配置kubectl logs支持边缘节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85EdgeMesh"><span class="nav-number">1.7.</span> <span class="nav-text">安装EdgeMesh</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KubeEdge%E7%BC%96%E8%AF%91"><span class="nav-number">1.8.</span> <span class="nav-text">KubeEdge编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Edgemesh%E7%BC%96%E8%AF%91"><span class="nav-number">1.9.</span> <span class="nav-text">Edgemesh编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2metrics-server"><span class="nav-number">1.10.</span> <span class="nav-text">部署metrics-server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubemark"><span class="nav-number">1.11.</span> <span class="nav-text">安装kubemark</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8edgemark"><span class="nav-number">1.12.</span> <span class="nav-text">使用edgemark</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">1.13.</span> <span class="nav-text">本地搭建集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2prometheus"><span class="nav-number">1.14.</span> <span class="nav-text">部署prometheus</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2grafana"><span class="nav-number">1.15.</span> <span class="nav-text">部署grafana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8"><span class="nav-number">1.16.</span> <span class="nav-text">部署应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95kubeedge"><span class="nav-number">1.17.</span> <span class="nav-text">测试kubeedge</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95mykubeedge"><span class="nav-number">1.18.</span> <span class="nav-text">测试mykubeedge</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="aliang"
      src="/images/maimai.jpg">
  <p class="site-author-name" itemprop="name">aliang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/MofishMuziyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;MofishMuziyu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://user.qzone.qq.com/3011109691" title="qq空间 → https:&#x2F;&#x2F;user.qzone.qq.com&#x2F;3011109691" rel="noopener" target="_blank"><i class="fa fa-qq fa-fw"></i>qq空间</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/qing-feng-32-2-86" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;qing-feng-32-2-86" rel="noopener" target="_blank"><i class="gratipay fa-fw"></i>知乎</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://library.nudt.edu.cn/" title="https:&#x2F;&#x2F;library.nudt.edu.cn" rel="noopener" target="_blank">图书馆</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aliang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.1/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  















  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
